"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[56210],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return d}});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),m=p(n),d=r,k=m["".concat(l,".").concat(d)]||m[d]||c[d]||o;return n?a.createElement(k,i(i({ref:t},u),{},{components:n})):a.createElement(k,i({ref:t},u))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var p=2;p<o;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},21110:function(e,t,n){n.r(t),n.d(t,{assets:function(){return u},contentTitle:function(){return l},default:function(){return d},frontMatter:function(){return s},metadata:function(){return p},toc:function(){return c}});var a=n(83117),r=n(80102),o=(n(67294),n(3905)),i=["components"],s={sidebar_position:15},l="Backup, Migrations and Restore",p={unversionedId:"manual/SCALE Apps/backup-restore",id:"manual/SCALE Apps/backup-restore",title:"Backup, Migrations and Restore",description:"This guide has been written with the best efforts of the staff and tested as best possible. We are not responsible if it doesn't work for every scenario or user situation.",source:"@site/docs/manual/SCALE Apps/backup-restore.md",sourceDirName:"manual/SCALE Apps",slug:"/manual/SCALE Apps/backup-restore",permalink:"/docs/manual/SCALE Apps/backup-restore",draft:!1,editUrl:"https://github.com/truecharts/website/tree/master/docs/manual/SCALE Apps/backup-restore.md",tags:[],version:"current",sidebarPosition:15,frontMatter:{sidebar_position:15},sidebar:"manualSidebar",previous:{title:"Docker-Compose on SCALE",permalink:"/docs/manual/SCALE Apps/docker-compose"},next:{title:"Accessing PVC Data",permalink:"/docs/manual/SCALE Apps/pvc-access"}},u={},c=[{value:"Requirements",id:"requirements",level:2},{value:"Backup",id:"backup",level:2},{value:"Exporting Backups",id:"exporting-backups",level:3},{value:"Checking Backups",id:"checking-backups",level:3},{value:"Restore",id:"restore",level:2},{value:"Reverting a running system",id:"reverting-a-running-system",level:3},{value:"Total System restore and Migration to new system",id:"total-system-restore-and-migration-to-new-system",level:3},{value:"Video Guide",id:"video-guide",level:2}],m={toc:c};function d(e){var t=e.components,s=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,a.Z)({},m,s,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"backup-migrations-and-restore"},"Backup, Migrations and Restore"),(0,o.kt)("admonition",{title:"Best Effort Policy",type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"This guide has been written with the best efforts of the staff and tested as best possible. We are not responsible if it doesn't work for every scenario or user situation.\nThis guide has been thoroughly tested with TrueNAS SCALE 22.02.4.")),(0,o.kt)("h2",{id:"requirements"},"Requirements"),(0,o.kt)("p",null,"This guide makes use of our command-line tool, called ",(0,o.kt)("inlineCode",{parentName:"p"},"TrueTool")," and assumes you've already created backups using the BASH TrueTool."),(0,o.kt)("p",null,"Please refer to the GitHub page for ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/truecharts/truetool"},"Truetool")," to follow the commands and instructions below. "),(0,o.kt)("h2",{id:"backup"},"Backup"),(0,o.kt)("h3",{id:"exporting-backups"},"Exporting Backups"),(0,o.kt)("p",null,"The above only creates only a backup of the kubernetes objects and a snapshot of the ",(0,o.kt)("inlineCode",{parentName:"p"},"PVC")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"ix_volume")," storage.\nThese backups are saved under the same ix_applications dataset."),(0,o.kt)("p",null,"It does not protect these against, for example, deletion of datasets or save them on an external system."),(0,o.kt)("p",null,"We ",(0,o.kt)("strong",{parentName:"p"},"highly")," advice making both an internal backup (separate dataset on the same system) ",(0,o.kt)("em",{parentName:"p"},"and")," an offsite backup.\nOne could create a normal recursive(!) replication of the ",(0,o.kt)("inlineCode",{parentName:"p"},"ix-volumes")," dataset using the SCALE GUI, with the following few special tricks by editing the replication after creation:"),(0,o.kt)("p",null,"To do so, setup the following replication task:"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"rep1",src:n(4699).Z,width:"1238",height:"1048"}),"\n",(0,o.kt)("img",{alt:"rep2",src:n(19496).Z,width:"1235",height:"1657"}),"\n",(0,o.kt)("img",{alt:"rep3",src:n(49896).Z,width:"1218",height:"1680"})),(0,o.kt)("p",null,"It's also important to ensure you keep regular config backups of the SCALE system itself, preferably right after the Apps backup above).\nHowever this is not part of this guide and we will assume you've done so yourself."),(0,o.kt)("h3",{id:"checking-backups"},"Checking Backups"),(0,o.kt)("p",null,"To make which backups are present, one can use ",(0,o.kt)("inlineCode",{parentName:"p"},"truetool")," command and select the 3rd option to get a list of backups"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"TrueTool-Main",src:n(47277).Z,width:"718",height:"786"})),(0,o.kt)("p",null,"Which results in"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"TrueTool-BackupList",src:n(11432).Z,width:"439",height:"394"})),(0,o.kt)("h2",{id:"restore"},"Restore"),(0,o.kt)("p",null,"One of the most important parts of backups is to ensure they can be restored.\nThere are two scenario's for a restore:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Reverting a working system")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Total System Restore"))),(0,o.kt)("h3",{id:"reverting-a-running-system"},"Reverting a running system"),(0,o.kt)("p",null,"Reverting a running system is rather trivial. But there are a few caveats:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"This will reinitialize the kubernetes node, which means all kubernetes objects that are not deployed using the Apps system will get reverted"),(0,o.kt)("li",{parentName:"ul"},"You CANNOT revert a single Apps")),(0,o.kt)("p",null,"To revert an existing system, the process is as follows:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"List your current backups using ",(0,o.kt)("inlineCode",{parentName:"p"},"truetool"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Select option 5 ",(0,o.kt)("inlineCode",{parentName:"p"},"Restore a Backup"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Choose Backup and answer the prompt"))),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"TrueTool-RestoreList",src:n(70278).Z,width:"742",height:"489"})),(0,o.kt)("p",null,"Please keep in mind this can take a LONG time, so be sure to wait a few hours before touching the system again.\nWhen done, a reboot might be adviceable"),(0,o.kt)("h3",{id:"total-system-restore-and-migration-to-new-system"},"Total System restore and Migration to new system"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"Sometimes you either need to wipe your system, Migrate to a new system or restore a system completely.\nWith the steps below, this is all very-much-possible.")),(0,o.kt)("admonition",{title:"Ensure a Clean system",type:"caution"},(0,o.kt)("ul",{parentName:"admonition"},(0,o.kt)("li",{parentName:"ul"},"Ensure a clean system, without Apps or configuration except the bare minimum network configuration"),(0,o.kt)("li",{parentName:"ul"},"Do not choose an apps pool yet, or do ANYTHING with apps until step 3"),(0,o.kt)("li",{parentName:"ul"},"Please do not restore SCALE configuration from backup-file, before Apps pool replication is finished."))),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Using ZFS replication, move back the previously backed-up ",(0,o.kt)("inlineCode",{parentName:"p"},"ix-applications")," dataset to the disk that will contain the future Apps Pool. This was covered in the ",(0,o.kt)("a",{parentName:"p",href:"#exporting-backups"},"Exporting Backups")," section.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("em",{parentName:"p"},"Optional/untested"),": When the SCALE system itself is also wiped, ensure to restore it using a SCALE config export ",(0,o.kt)("strong",{parentName:"p"},"first"),".")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Once the ZFS replication is complete, on the new or migrated system navigate to the ",(0,o.kt)("strong",{parentName:"p"},"Apps")," tab in the Truenas Scale GUI. When prompted to select a pool, select the pool containing the ",(0,o.kt)("inlineCode",{parentName:"p"},"ix-applications")," dataset.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Run the following command in your Truenas Scale shell to fix known issues with PVC storage."))),(0,o.kt)("blockquote",null,(0,o.kt)("pre",{parentName:"blockquote"},(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'zfs set mountpoint=legacy "$(zfs list -t filesystem -r "$(cli -c \'app kubernetes config\' | grep -E "pool\\s\\|" | awk -F \'|\' \'{print $3}\' | tr -d " \\t\\n\\r")" -o name -H | grep "volumes/pvc")" \n'))),(0,o.kt)("ol",{start:5},(0,o.kt)("li",{parentName:"ol"},"All you need to do now is restore the Truetool snapshot of your ",(0,o.kt)("inlineCode",{parentName:"li"},"ix-applications")," dataset by following the ",(0,o.kt)("a",{parentName:"li",href:"#reverting-a-running-system"},"Reverting a running system")," guide above.")),(0,o.kt)("h2",{id:"video-guide"},"Video Guide"),(0,o.kt)("p",null,"TBD"))}d.isMDXComponent=!0},4699:function(e,t,n){t.Z=n.p+"assets/images/Replication1-69b7272922b1d8f8275ffe3f12cc97d7.png"},19496:function(e,t,n){t.Z=n.p+"assets/images/Replication2-605b41570010b7895ed57977fc7a8df9.png"},49896:function(e,t,n){t.Z=n.p+"assets/images/Replication3-bc79978e4f2cbee39ee74b5559394bcf.png"},11432:function(e,t,n){t.Z=n.p+"assets/images/TrueTool-Backup-List-cf91ddec58d9db7d4f2b190244eb5ef9.png"},47277:function(e,t,n){t.Z=n.p+"assets/images/TrueTool-Main-4003db7f3358b9abb466b2a20d3757c0.png"},70278:function(e,t,n){t.Z=n.p+"assets/images/TrueTool-Restore-List-81a1a241399fd8515837e01e78f81b11.png"}}]);